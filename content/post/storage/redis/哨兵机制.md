---
title: "Redis 哨兵机制"
discriptions: "Redis 哨兵机制"
date: 2022-06-26T19:25:11+08:00
author: Pismery Liu
archives: "2022"
tags: [Redis]
categories: []
showtoc: true
draft: true
---

本文主要梳理 Redis 哨兵机制的流程与细节；

<!--more-->

# Redis 哨兵机制

## 概要

主从集群发生主实例宕机时，会导致新的写操作无法进行，主从无法同步，这是大部分应用场景不可接受的，此时 Redis 引入哨兵机制解决选主问题；哨兵其实就是一个特殊模式的 Redis 进程，主要负责三个任务：监控，选主，通知;


## 哨兵执行基本流程

1. 哨兵周期性的给所有主从实例发送 ping 命令，检测它们是否仍然在线；
2. 如果主实例被判定为客观下线，进行主从切换的流程；
3. 从哨兵集群中选择一个哨兵负责此次主从切换，进行选主工作；
4. 选主完毕，则通知其他从实例，让它们执行 replicaof 命令和新主实例建立连接，同时发送新主实例消息给客户端，让客户端把后续写请求发送到新主实例中；

### 监控流程

哨兵主要功能就是监控主从集群，判断他们的状态，进行主从切换操作。首先需要保证状态识别的准确性，原因是Redis 集群负载越高，哨兵越容易误判，而进行主从切换需要重新选主和同步操作都会带来额外的计算和通信开销，再进行主从切换就更加加大集群的压力；

Redis 哨兵通过「主观下线」和「客观下线」来尽可能保证状态识别的准确性；哨兵通过 ping 命令检测自己与主从实例的网络状态，如果发现 ping 命令超时或者不通，则将实例标记为「主观下线」；

如果是从实例超时，哨兵会直接标记从实例为「主观下线」，因为从实例下线不会影响主从集群的可用性；如果是主实例，我们一般为了避免单个哨兵误判的情况，会部署哨兵集群；此时，需要哨兵集群中的大多数哨兵都判断主实例「主观下线」，此时再标记主实例为「客观下线」再进行主从切换；

哨兵集群中需要判断「主观下线」的哨兵数由哨兵配置文件中的 「quorum」来设置；例如 5 个哨兵， 「quorum」配置为 3，则需要哨兵自己的赞成票以及另外两个哨兵的赞成票，就可以标记主实例为「客观下线」了；

哨兵集群间是如何交互对主实例状态的判断呢？其主要是通过 「is-master-down-by-addr」命令；当任何一个哨兵判断主实例「主观下线」则会向其他哨兵发送 「is-master-down-by-addr」，然后其他实例会根据自身跟主实例的连接情况回复 Y（赞成票） 或 N （反对票）;

### 选主流程

在哨兵标记主实例为客观下线后，哨兵集群之间需要选出一个哨兵 Leader，来主导主从切换；哨兵 Leader 的选举跟判断主实例是否「客观下线」类似；选举的规则如下：

1. Leader 哨兵需要获得半数以上的赞成票，同时票数要大于等于 「quorum」的值；
2. 每一个哨兵实例只有一票；
3. 如果经过一轮选举没有哨兵选举成功，则集群等待哨兵故障转移时间的 2 倍后，重新选举；因为选举依赖哨兵集群的网络环境，选举失败大部分情况是网络拥堵，因此等到网络好转后重新选举投票；


### 通知流程
